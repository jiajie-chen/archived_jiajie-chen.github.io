<head>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
	<script type="text/javascript">
		function getCanvasPixels(canvasElement) {
			var context = canvasElement.getContext("2d");
			var w = canvasElement.width;
			var h = canvasElement.height;

			var rawData = context.getImageData(0, 0, w, h);
			var pixelData = {'width':rawData.width, 'height':rawData.height, 'data':[]};
			for (let i = 0; i < (rawData.width * rawData.height * 4); i += 4) {
				pixelData.data.push({
					'red': rawData.data[i+0],
					'green': rawData.data[i+1],
					'blue': rawData.data[i+2],
					'alpha': rawData.data[i+3]
				});
			}

			return pixelData;
		}

		function putCanvasPixels(canvasElement, pixelData) {
			var context = canvasElement.getContext("2d");
			var w = pixelData.width;
			var h = pixelData.height;

			var rawData = context.getImageData(0, 0, w, h);
			for (let i = 0; i < (rawData.width * rawData.height); i += 1) {
				rawData.data[(i*4)+0] = pixelData.data[i].red;
				rawData.data[(i*4)+1] = pixelData.data[i].green;
				rawData.data[(i*4)+2] = pixelData.data[i].blue;
				rawData.data[(i*4)+3] = pixelData.data[i].alpha;
			}

			context.putImageData(rawData, 0, 0);
		}

		function compareByBrightness(pixelA, pixelB) {
			var a = pixelA.red + pixelA.green + pixelA.blue;
			var b = pixelB.red + pixelB.green + pixelB.blue;
			return a-b;
		}

		function sortNPixels(pixelData, comparator, numPx) {
			for (let i = 0; i < pixelData.data.length - numPx; i += numPx) {
				var slice = [];
				for (let j = 0; j < numPx; j++) {
					slice.push(pixelData.data[i+j]);
				}

				slice.sort(comparator);
				for (let j = 0; j < numPx; j++) {
					pixelData.data[i+j] = slice[j];
				}
			}
		}

		function isPixelBlack(threshold) {
			return function(x, y, pixelData) {
				var px = pixelData.data[y*pixelData.width + x];
				var bright = px.red + px.green + px.blue;
				return bright < (threshold * 3);
			};
		}

		function isPixelWhite(threshold) {
			return function(x, y, pixelData) {
				var px = pixelData.data[y*pixelData.width + x];
				var bright = px.red + px.green + px.blue;
				return bright > (threshold * 3);
			};
		}

		function sortPixelRow(pixelData, comparator, startPred, stopPred) {
			for (let i = 0; i < pixelData.height; i++) {
				let j = 0;
				while (j < pixelData.width && !startPred(j, i, pixelData)) {
					j++;
				}

				var start = j;
				var slice = [];
				while (j < pixelData.width && !stopPred(j, i, pixelData)) {
					slice.push(pixelData.data[i*pixelData.width + j]);
					j++;
				}

				slice.sort(comparator);
				for (let k = 0; k < slice.length; k++) {
					pixelData.data[i*pixelData.width + start+k] = slice[k];
				}
			}
		}

		function sortPixelColumn(pixelData, comparator, startPred, stopPred) {
			for (let i = 0; i < pixelData.width; i++) {
				let j = 0;
				while (j < pixelData.height && !startPred(i, j, pixelData)) {
					j++;
				}

				var start = j;
				var slice = [];
				while (j < pixelData.height && !stopPred(i, j, pixelData)) {
					slice.push(pixelData.data[j*pixelData.width + i]);
					j++;
				}

				slice.sort(comparator);
				for (let k = 0; k < slice.length; k++) {
					pixelData.data[(start+k)*pixelData.width + i] = slice[k];
				}
			}
		}

		function sortPixelRowReverse(pixelData, comparator, startPred, stopPred) {
			for (let i = pixelData.height - 1; i >= 0; i--) {
				let j = pixelData.width - 1;
				while (j >= 0 && !startPred(j, i, pixelData)) {
					j--;
				}

				var start = j;
				var slice = [];
				while (j >= 0 && !stopPred(j, i, pixelData)) {
					slice.push(pixelData.data[i*pixelData.width + j]);
					j--;
				}

				slice.sort(comparator);
				for (let k = 0; k < slice.length; k++) {
					pixelData.data[i*pixelData.width + start-k] = slice[k];
				}
			}
		}

		function sortPixelColumnReverse(pixelData, comparator, startPred, stopPred) {
			for (let i = pixelData.width - 1; i >= 0; i--) {
				let j = pixelData.height - 1;
				while (j >= 0 && !startPred(i, j, pixelData)) {
					j--;
				}

				var start = j;
				var slice = [];
				while (j >= 0 && !stopPred(i, j, pixelData)) {
					slice.push(pixelData.data[j*pixelData.width + i]);
					j--;
				}

				slice.sort(comparator);
				for (let k = 0; k < slice.length; k++) {
					pixelData.data[(start-k)*pixelData.width + i] = slice[k];
				}
			}
		}

		function offsetCoord(origin, offset, bound) {
			var range = bound;
			var newOrigin = origin + offset;

			if (newOrigin < 0) {
				newOrigin += range * Math.floor((-newOrigin) / range + 1);
			}

			return (newOrigin) % range;
		}

		function offsetChannels(pixelData, redOffsetX, redOffsetY, greenOffsetX, greenOffsetY, blueOffsetX, blueOffsetY) {
			var red = [];
			var green = [];
			var blue = [];

			for (let i = 0; i < pixelData.data.length; i++) {
				red.push(pixelData.data[i].red);
				green.push(pixelData.data[i].green);
				blue.push(pixelData.data[i].blue);
			}

			for (let x = 0; x < pixelData.width; x++)
			for (let y = 0; y < pixelData.height; y++) {
				let redIdx =
					offsetCoord(y, -redOffsetY, pixelData.height) * pixelData.width +
					offsetCoord(x, -redOffsetX, pixelData.width);
				let greenIdx =
					offsetCoord(y, -greenOffsetY, pixelData.height) * pixelData.width +
					offsetCoord(x, -greenOffsetX, pixelData.width);
				let blueIdx =
					offsetCoord(y, -blueOffsetY, pixelData.height) * pixelData.width +
					offsetCoord(x, -blueOffsetX, pixelData.width);

				var px = pixelData.data[y*pixelData.width + x];
				px.red = red[redIdx];
				px.green = green[greenIdx];
				px.blue = blue[blueIdx];
			}

			
		}

		function randInt(min, max){
			return Math.floor(Math.random() * (max+1-min)) + min;
		}

		function datamosh(canvasId, mosh) {
			var canvas = document.getElementById(canvasId);
			var px = getCanvasPixels(canvas);

			if (mosh === 0) {
				sortNPixels(px, compareByBrightness, 20);
			} else if (mosh === 1) {
				var rand = randInt(-2, 8);
				if (rand === 0) {
					sortPixelRow(px, compareByBrightness, isPixelWhite(randInt(150, 200)), isPixelBlack(randInt(10, 60)));
				} else if (rand === 1) {
					sortPixelColumn(px, compareByBrightness, isPixelWhite(randInt(150, 200)), isPixelBlack(randInt(10, 60)));
				} else if (rand === 2) {
					sortPixelRowReverse(px, compareByBrightness, isPixelWhite(randInt(150, 200)), isPixelBlack(randInt(10, 60)));
				} else if (rand === 3) {
					sortPixelColumnReverse(px, compareByBrightness, isPixelWhite(randInt(150, 200)), isPixelBlack(randInt(10, 60)));
				} else if (rand < 0) {
					offsetChannels(px,
						randInt(-5, 5), randInt(-5, 5),
						randInt(-5, 5), randInt(-5, 5),
						randInt(-5, 5), randInt(-5, 5));
				}
			}

			putCanvasPixels(canvas, px);
		}

		function loadImageToCanvas(canvasId, imageSource) {
			var image1 = new Image();
			image1.onload = function () {
				var c = document.getElementById(canvasId);
				c.width = image1.width;
				c.height = image1.height;
				c.style.width = image1.width;
				c.style.height = image1.height;

				c.getContext("2d").drawImage(image1, 0, 0);
			};
			image1.src = imageSource;
		}

		loadImageToCanvas('image1', 'meme1.jpg');
		loadImageToCanvas('image2', 'meme2.jpg');
		loadImageToCanvas('image3', 'meme3.jpg');
		loadImageToCanvas('image4', 'meme4.jpg');
		loadImageToCanvas('image5', 'meme5.jpg');
	</script>

	<style type="text/css">
		.meme {
			position: relative; 
			width: 100%;
		}

		#meme-text-1 {
			color: black;
			text-shadow:
				2px 0 #fff,
				-2px 0 #fff,  
				0 -2px #fff,
				0 2px #fff,
				2px 2px #fff,
				-2px -2px #fff,  
				2px -2px #fff,
				-2px 2px #fff;

			position: absolute;
			top: 90%;
			left: 0;
			width: 100%;

			text-align: center;
			font-size: 24px;
		}

		#meme-text-2 {
			background-color: black;
			color: white;

			position: absolute;
			top: 40%;
			left: 3%;
			width: 40%;

			text-align: left;
			font-size: 18px;
		}
	</style>
</head>

<body>
<div class="container">
	<div class="col-md-3">
		<h1 class="text-center">House of Fragile Memes</h1>
		<br/>
		<h5 class="text-right">please don't touch</h5>
		<br/>
		<h5 class="text-left">caution: breaks easily</h5>
	</div>

	<div class="col-md-8 col-md-offset-1">
		<div class="meme" onmousemove="datamosh('image1', 1)" onclick="datamosh('image1', 0)">
			<canvas id="image1"></canvas>
			<span id="meme-text-1">Archaeologist examines vintage 18th century meme, 1970</span>
		</div>

		<br/>

		<div class="meme" onmousemove="datamosh('image2', 1)" onclick="datamosh('image2', 0)">
			<canvas id="image2"></canvas>
			<span id="meme-text-2">Do you realize that if you fall into a black hole, you will see the entire future of the Universe unfold in front of you in a matter of moments and you will emerge into another space-time created by the singularity of the black hole you just fell into?</span>
		</div>

		<br/>

		<div class="meme" onmousemove="datamosh('image3', 1)" onclick="datamosh('image3', 0)">
			<canvas id="image3"></canvas>
		</div>

		<br/>

		<div class="meme" onmousemove="datamosh('image4', 1)" onclick="datamosh('image4', 0)">
			<canvas id="image4"></canvas>
		</div>

		<br/>

		<div class="meme" onmousemove="datamosh('image5', 1)" onclick="datamosh('image5', 0)">
			<canvas id="image5"></canvas>
		</div>
	</div>
</div>
</body>